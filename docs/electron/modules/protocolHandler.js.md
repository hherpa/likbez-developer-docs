# modules/protocolHandler.js

## Описание

Обработчик кастомного протокола likbez:// Electron приложения Likbez. Обеспечивает безопасный доступ к медиафайлам с поддержкой byte-range запросов для потокового воспроизведения.

## Основные функции

### registerProtocol(protocol)

Регистрирует кастомный протокол likbez:// с использованием stream протокола Electron. Все запросы к протоколу обрабатываются методом handleRequest.

### handleRequest(request, callback)

Обрабатывает входящие запросы к протоколу:

- Валидирует путь к файлу
- Проверяет существование файла
- Определяет MIME тип файла
- Обрабатывает запросы с Range заголовком для потокового воспроизведения
- Обрабатывает полные запросы файлов

### extractRangeHeader(request)

Извлекает заголовок Range из запроса для поддержки частичной загрузки файлов.

### handleRangeRequest(filePath, range, total, mimeType, callback)

Обрабатывает запросы с Range заголовком для поддержки потокового воспроизведения:

- Парсит диапазон байтов из заголовка
- Валидирует диапазон
- Создает поток чтения для указанного диапазона
- Возвращает частичное содержимое файла с кодом 206

### handleFullRequest(filePath, total, mimeType, callback)

Обрабатывает полные запросы файлов:

- Создает поток чтения всего файла
- Возвращает полное содержимое файла с кодом 200

### isFileAccessible(relPath)

Проверяет доступность файла по протоколу:

- Валидирует путь к файлу
- Проверяет существование файла в файловой системе

### getFileInfo(relPath)

Получает информацию о файле для протокола:

- Валидирует путь к файлу
- Проверяет существование файла
- Возвращает информацию о размере, MIME типе, дате модификации и URL протокола

### validateProtocolUrl(url)

Валидирует URL протокола:

- Проверяет, что URL начинается с likbez://
- Валидирует путь к файлу

## Поддержка потокового воспроизведения

Протокол поддерживает потоковое воспроизведение медиафайлов благодаря:

- Обработке Range заголовков
- Возврату частичного содержимого файлов с кодом 206
- Поддержке Content-Range и Accept-Ranges заголовков
- Кэшированию файлов с помощью Cache-Control

## Безопасность

Обработчик обеспечивает безопасность путем:

- Валидации всех путей к файлам
- Предотвращения path traversal атак
- Ограничения доступа только к файлам в dataRoot директории

## Импорты

- fs: модуль для работы с файловой системой
- path: модуль для работы с путями файловой системы
- FileUtils, MimeUtils, ValidationUtils из ./utils: утилиты для работы с файлами, MIME типами и валидацией