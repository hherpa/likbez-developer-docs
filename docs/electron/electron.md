# Архитектура Electron приложения Likbez

## Общая архитектура

Приложение Likbez построено на базе Electron, что позволяет создавать кроссплатформенные десктопные приложения с использованием веб-технологий. Архитектура приложения состоит из двух основных процессов:

1. **Main процесс** - главный процесс приложения, отвечающий за создание окон, управление жизненным циклом приложения и взаимодействие с операционной системой.
2. **Renderer процесс** - процесс веб-страницы, отвечающий за отображение пользовательского интерфейса и бизнес-логику.

## Структура проекта

```
electron/
├── main.js                 # Точка входа в приложение
├── preload.js              # Предзагрузочный скрипт для обеспечения безопасности
├── modules/                # Модули приложения
│   ├── apiBridge.js        # Мост для взаимодействия с API
│   ├── dataManager.js      # Управление данными приложения
│   ├── index.js            # Индексный файл модулей
│   ├── protocolHandler.js # Обработчик кастомного протокола
│   ├── utils.js            # Вспомогательные функции
│   ├── ipc/                # Обработчики IPC сообщений
│   ├── media/              # Управление медиафайлами
│   └── storage/            # Хранение и сериализация данных
```

## Основные компоненты

### Main процесс (main.js)

Файл `main.js` является точкой входа в приложение. Он отвечает за:

- Регистрацию кастомного протокола `likbez`
- Создание главного окна приложения
- Настройку параметров безопасности (contextIsolation, nodeIntegration)
- Управление жизненным циклом приложения
- Инициализацию обработчиков IPC сообщений

### Предзагрузочный скрипт (preload.js)

Скрипт `preload.js` выполняется в контексте веб-страницы до её загрузки. Он обеспечивает безопасное взаимодействие между renderer и main процессами через:

- Предоставление безопасного API для renderer процесса
- Ограничение доступа к Node.js API из веб-страницы
- Настройку контекстной изоляции

### Модуль управления данными (dataManager.js)

Модуль `dataManager.js` отвечает за:

- Управление данными приложения
- Работу с файловой системой
- Сериализацию и десериализацию данных
- Отслеживание изменений в файлах

### Модуль обработки IPC сообщений (ipcHandlers.js)

Модуль `ipcHandlers.js` централизует обработку сообщений между main и renderer процессами:

- Регистрацию обработчиков для различных типов сообщений
- Управление данными через IPC
- Работу с медиафайлами через IPC
- Управление тегами через IPC
- Отслеживание изменений файлов через IPC

### Модуль управления медиафайлами (mediaManager.js)

Модуль `mediaManager.js` отвечает за:

- Импорт и экспорт медиафайлов
- Работу с изображениями и другими медиафайлами
- Генерацию превью для медиафайлов
- Управление медиа-репозиторием

### Модуль хранения данных (storageService.js)

Модуль `storageService.js` отвечает за:

- Хранение данных приложения
- Сериализацию узлов данных
- Работу с репозиторием узлов
- Отслеживание изменений в файловой системе

## Безопасность

Приложение следует лучшим практикам безопасности Electron:

- Использует контекстную изоляцию (contextIsolation)
- Отключает интеграцию с Node.js (nodeIntegration: false)
- Использует предзагрузочные скрипты для безопасного API
- Регистрирует кастомный протокол с ограниченными привилегиями

## Разработка и отладка

В режиме разработки приложение:

- Загружает контент с локального сервера разработки
- Автоматически открывает инструменты разработчика
- Поддерживает горячую перезагрузку

В production режиме:

- Загружает статические файлы из папки build
- Отключает инструменты разработчика
- Оптимизирует производительность

## Жизненный цикл приложения

Приложение управляется стандартными событиями Electron:

- `app.on('ready')` - инициализация приложения
- `app.on('activate')` - активация приложения (macOS)
- `app.on('window-all-closed')` - завершение работы приложения
- `app.on('quit')` - очистка ресурсов перед завершением

## Настройка окна приложения

Главное окно приложения настроено с учетом требований:

- Минимальный размер: 1024x640
- Автоматическое скрытие меню на Windows
- Контекстная изоляция для безопасности
- Предзагрузочный скрипт для безопасного API

## Кастомный протокол

Приложение регистрирует кастомный протокол `likbez` с привилегиями:

- Стандартный протокол (standard: true)
- Безопасный протокол (secure: true)
- Поддержка Fetch API (supportFetchAPI: true)
- Поддержка потоков (stream: true)
- Включенный CORS (corsEnabled: true)

Это позволяет использовать протокол `likbez://` для доступа к ресурсам приложения с теми же возможностями, что и стандартные веб-протоколы.