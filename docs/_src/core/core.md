# Архитектура Core модуля приложения Likbez

## Общая архитектура

Core модуль приложения Likbez представляет собой фундаментальную часть приложения, содержащую основные компоненты, провайдеры состояния и кастомные хуки. Модуль построен по принципам компонентной архитектуры React с использованием Context API для управления состоянием.

Архитектура модуля состоит из трех основных частей:

1. **Компоненты приложения** - основные визуальные компоненты приложения
2. **Провайдеры** - React Context провайдеры для управления глобальным состоянием
3. **Хуки** - кастомные хуки для работы с различными аспектами приложения

## Структура проекта

```
src/core/
├── app/        # Основные компоненты приложения
│   ├── App.js  # Главный компонент приложения
│   ├── App.css # Стили главного компонента
│   ├── FlowContainer.js # Контейнер для ReactFlow
│   ├── appConstants.js  # Константы приложения
│   └── index.js         # Экспорт компонентов app
│
├── providers/              # React Context провайдеры
│   ├── AppProvider.js      # Глобальное состояние приложения
│   ├── ElectronProvider.js # Интеграция с Electron
│   ├── FlowProvider.js    # Состояние потока узлов
│   ├── NavigationProvider.js # Состояние навигации
│   └── index.js            # Экспорт всех провайдеров
│
├── hooks/                  # Кастомные хуки по категориям
│   ├── app/                # Хуки для работы с данными приложения
│   │   ├── useAppData.js   # Получение и обновление данных приложения
│   │   ├── useNodeSave.js  # Сохранение узлов
│   │   ├── useFileExplorerNavigation.js # Навигация в файловом проводнике
│   │   └── index.js        # Экспорт app хуков
│   │
│   ├── diagram/             # Хуки для работы с диаграммами
│   │   ├── useNodeDrop.js  # Drag & Drop узлов
│   │   ├── useNodeNavigation.js # Навигация между узлами
│   │   └── index.js        # Экспорт diagram хуков
│   │
│   ├── editor/             # Хуки для работы с редактором
│   │   ├── useNodeEditor.js # Редактор узлов
│   │   ├── useImageUpload.js # Загрузка изображений
│   │   ├── useDropdown.js   # Управление выпадающими списками
│   │   ├── useFloatingToolbar.js # Плавающая панель инструментов
│   │   ├── useTextarea.js # Текстовая область
│   │   ├── useEditorTabs.js # Вкладки редактора
│   │   ├── useEditorPreview.js # Предпросмотр редактора
│   │   ├── useEditorNodeWidth.js # Ширина узла редактора
│   │   ├── usePreviewMode.js # Режим предпросмотра
│   │   ├── useSyntaxHighlight.js # Подсветка синтаксиса
│   │   ├── useEditorContainer.js # Контейнер редактора
│   │   ├── useEditorKeyboardControls.js # Управление клавиатурой
│   │   ├── useEditorModalControls.js # Управление модальными окнами
│   │   ├── useEditorTabs.js # Вкладки редактора
│   │   ├── useFloatingToolbar.js # Плавающая панель инструментов
│   │   ├── useImageUpload.js # Загрузка изображений
│   │   ├── useNodeEditor.js # Редактор узлов
│   │   ├── usePreviewMode.js # Режим предпросмотра
│   │   ├── useSyntaxHighlight.js # Подсветка синтаксиса
│   │   ├── useTextarea.js # Текстовая область
│   │   ├── useTextareaView.js # Представление текстовой области
│   │   │
│   │   ├── preview/        # Хуки для предпросмотра
│   │   │   ├── useBackspaceKeyHandler.js # Обработчик клавиши Backspace
│   │   │   ├── useEditableElement.js # Редактируемый элемент
│   │   │   ├── useEditingFocus.js # Фокус редактирования
│   │   │   ├── useEditValue.js # Значение редактирования
│   │   │   ├── useEnterKeyHandler.js # Обработчик клавиши Enter
│   │   │   ├── useTextExtraction.js # Извлечение текста
│   │   │   └── useToolbarSelection.js # Выбор панели инструментов
│   │   │
│   │   ├── toolbar/        # Хуки для панели инструментов
│   │   │   ├── useDropdownManager.js # Управление выпадающими списками
│   │   │   ├── useToolbarAnimation.js # Анимация панели инструментов
│   │   │   └── useToolbarPosition.js # Позиция панели инструментов
│   │   │
│   │   └── index.js        # Экспорт editor хуков
│   │
│   ├── navigation/          # Хуки для навигации
│   │   ├── useNavigation.js # Основная навигация
│   │   ├── useLevelNavigation.js # Навигация по уровням
│   │   ├── useUI.js        # UI состояние
│   │   └── index.js        # Экспорт navigation хуков
│   │
│   ├── storage/            # Хуки для хранения данных
│   │   ├── useApp.js       # Глобальное состояние приложения
│   │   ├── useDataPersistence.js # Сохранение данных
│   │   ├── useTheme.js     # Управление темой
│   │   └── index.js        # Экспорт storage хуков
│   │
│   └── index.js            # Главный экспорт hooks
│
└── index.js # Главный экспорт core модуля

## Основные компоненты

### Приложение (app/)

Каталог `app/` содержит основные компоненты приложения:

- `App.js` - главный компонент, который служит точкой входа для React приложения. Он координирует работу всех компонентов приложения, включая диаграмму, редактор и боковую панель. Также отвечает за интеграцию с провайдерами и хуками.
- `App.css` - глобальные стили приложения
- `FlowContainer.js` - контейнер для визуализации узлов с помощью ReactFlow
- `appConstants.js` - константы, используемые по всему приложению

!> Необходимо обеспечить правильную инициализацию всех компонентов приложения для корректной работы

### Провайдеры (providers/)

Каталог `providers/` содержит React Context провайдеры для управления состоянием приложения:

- `AppProvider.js` - управляет глобальным состоянием приложения, включая теги категорий. Использует хук `useApp` для управления состоянием.
- `ElectronProvider.js` - обеспечивает интеграцию с Electron API, предоставляя безопасный доступ к Electron функциям через контекст.
- `FlowProvider.js` - управляет состоянием потока узлов, включая узлы и связи. Использует хук `useNodeEdges` из компонентов диаграммы.
- `NavigationProvider.js` - управляет состоянием навигации между уровнями. Использует хук `useNavigation` для управления стеком навигации.

!> Важно правильно настроить провайдеры в правильном порядке для избежания проблем с зависимостями

### Хуки (hooks/)

Каталог `hooks/` содержит кастомные хуки, разделенные по категориям:

#### Хуки приложения (app/)

- `useAppData.js` - хук для подготовки данных приложения, включая доступные теги и узлы. Централизует логику подготовки этих данных.
- `useNodeSave.js` - хук для сохранения узлов с обновлением subLevels. Централизует логику сохранения узлов во всех уровнях.
- `useFileExplorerNavigation.js` - хук для навигации к узлам из File Explorer. Централизует логику определения уровня и навигации к узлу.

#### Хуки диаграмм (diagram/)

- `useNodeDrop.js` - хук для обработки drag & drop узлов на холст ReactFlow. Создает новые узлы при перетаскивании из боковой панели.
- `useNodeNavigation.js` - хук для навигации к узлу на холсте ReactFlow. Анимирует переход к указанному узлу.

#### Хуки редактора (editor/)

- `useNodeEditor.js` - хук для управления состоянием редактора узлов. Заменяет старую систему двойного клика и форм редактирования.
- `useImageUpload.js` - хук для обработки drag&drop изображений в редактор. Сохраняет изображения в папку data/ и возвращает относительные пути.
- `useDropdown.js` - хук для общей логики работы dropdown компонентов. Инкапсулирует общее поведение: клик вне, клавиатура, получение выделенного текста.
- `useFloatingToolbar.js` - хук для координации между textarea и FloatingToolbar. Управляет состоянием видимости и позиционированием плавающего тулбара.

#### Хуки навигации (navigation/)

- `useNavigation.js` - хук для управления навигацией между уровнями. Содержит логику для двойного клика по узлам, возврата назад и управления стеком навигации.
- `useLevelNavigation.js` - хук для управления навигацией между уровнями настроек. Определяет текущий уровень настроек и позволяет переходить между ними.
- `useUI.js` - хук для UI состояния приложения (меню, выбранные узлы, инстанс ReactFlow). Управляет состоянием правого меню и выбранных узлов.

#### Хуки хранения данных (storage/)

- `useApp.js` - хук для глобального состояния приложения (теги). Управляет тегами категорий и их цветами.
- `useDataPersistence.js` - хук для автоматического сохранения и загрузки данных. Поддерживает как старый формат узлов, так и новый markdown формат.
- `useTheme.js` - хук для управления темой приложения. Вычисляет темную тему на основе настроек и предоставляет функцию переключения темы.

## Интеграция с Electron

Core модуль тесно интегрирован с Electron через `ElectronProvider.js`, который предоставляет безопасный доступ к Electron API из renderer процесса. Также используется в `useDataPersistence.js` для сохранения и загрузки данных.

!> Необходимо следить за безопасностью при интеграции с Electron API

## Разработка и отладка

В процессе разработки core модуля:

- Используются современные возможности JavaScript (ES6+)
- Следуются принципы функционального программирования
- Обеспечивается типобезопасность (при использовании TypeScript в будущем)
- Соблюдаются принципы компонентной архитектуры React

## Зависимости

Core модуль зависит от следующих библиотек:

- React и React DOM
- React Context API
- ReactFlow для визуализации узлов
- Electron (для десктопной версии)

!> Необходимо следить за совместимостью версий зависимостей

## Тестирование

Компоненты core модуля должны покрываться unit-тестами. Рекомендуется использовать Jest и React Testing Library для написания тестов.

## Производительность

При разработке core модуля следует учитывать:

- Минимизацию перерендеров компонентов
- Эффективное управление состоянием
- Оптимизацию хуков с помощью useMemo и useCallback
- Ленивую загрузку компонентов при необходимости
