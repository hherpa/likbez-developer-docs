# TagApplier Utility Documentation

## Описание
TagApplier - это утилита для применения тегов к узлам в системе редактора. Функция `applyTagToNode` отвечает за обновление тега у конкретного узла, включая обновление содержимого узла и визуальных свойств. Утилита интегрируется с системой парсинга тегов и системой управления узлами.

## Экспортируемые компоненты
- `applyTagToNode` - основная функция для применения тега к узлу

## Структура функции
1. **Поиск существующего тега**:
   - Поиск тега в локальном хранилище тегов
   - Извлечение цвета тега или использование цвета по умолчанию

2. **Обновление категории тегов**:
   - Вызов коллбэка `updateCategoryTag` для обновления категории тегов

3. **Обновление содержимого узла**:
   - Обновление содержимого узла через функцию `setNodes`
   - Удаление старых тегов из содержимого
   - Добавление нового тега после заголовка или в начало содержимого

4. **Обновление визуальных свойств**:
   - Установка тега и цвета границы в данных узла

## Взаимодействия
Функция `applyTagToNode` принимает три параметра:
- `context` - контекст с методами для обновления тегов и узлов
- `nodeId` - идентификатор узла, к которому применяется тег
- `tagValue` - значение применяемого тега

Функция взаимодействует с контекстом через следующие методы:
- `localTags` - локальное хранилище тегов для поиска цвета
- `updateCategoryTag` - метод для обновления категории тегов
- `setNodes` - метод для обновления узлов

При обновлении содержимого узла:
1. Удаляются все старые теги из содержимого (паттерн `{.tag}...{.tag}`)
2. Новый тег добавляется после заголовка (первая строка, начинающаяся с #) или в начало содержимого
3. Содержимое нормализуется для удаления лишних пустых строк

## Зависимости
- `extractTags` из '../../../system/parser' (для парсинга тегов)
- Контекст редактора с методами обновления тегов и узлов

## Архитектура
Утилита следует паттерну чистой функции, которая принимает контекст и параметры, и выполняет побочные эффекты через переданные коллбэки. Функция инкапсулирует сложную логику обновления содержимого узла и визуальных свойств. Используется функциональный подход с иммутабельными обновлениями через map. Функция следует принципу единственной ответственности - она только отвечает за применение тега к узлу. Логика обновления содержимого узла включает парсинг, модификацию и нормализацию текста. Функция поддерживает как узлы с содержимым, так и узлы без содержимого. При обновлении содержимого используется регулярное выражение для удаления старых тегов и алгоритм для вставки нового тега в правильное место. Функция экспортируется как именованный экспорт, что позволяет импортировать ее выборочно. Все обновления выполняются через переданные коллбэки, что обеспечивает гибкость в использовании утилиты. Функция не имеет внутреннего состояния и зависит только от переданных параметров.