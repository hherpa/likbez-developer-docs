# useNodeSave.js

## Обзор

Пользовательский React хук для сохранения узлов с обновлением данных во всех уровнях навигации. Централизует логику сохранения узлов и синхронизирует изменения между текущим состоянием и всеми уровнями.

## Назначение

useNodeSave отвечает за:
- Сохранение данных узлов с обновлением во всех уровнях навигации
- Интеграцию с хуком редактора узлов
- Синхронизацию изменений между контекстами диаграммы и навигации

## Зависимости

Хук использует следующие контексты и хуки:
- `useNodeEditor` из `../editor/useNodeEditor` - для сохранения узлов
- `useFlowContext` из `../../providers` - для обновления узлов в текущем состоянии
- `useNavigationContext` из `../../providers` - для обновления узлов во всех уровнях
- `updateNodeInList` из `../../../components/editor/system` - для обновления списков узлов
- `useCallback` из React - для мемоизации функции сохранения

## Возвращаемое значение

Хук возвращает объект с одним свойством:

### handleSaveNode
Функция для сохранения узла с обновлением данных во всех уровнях:
```javascript
const handleSaveNode = useCallback((nodeId, nodeData) => {
  // ... логика сохранения
}, [saveNode, setNodes, setSubLevels]);
```

Функция принимает:
- `nodeId` - идентификатор узла
- `nodeData` - новые данные узла

!> Используется мемоизация для оптимизации производительности

## Логика работы

### Обновление текущего состояния
Функция обновляет узел в текущем состоянии диаграммы:
```javascript
setNodes(prevNodes => updateNodeInList(prevNodes, id, data));
```

### Обновление всех уровней
Функция обновляет узел во всех уровнях навигации:
```javascript
setSubLevels(prevSubLevels => {
  const updatedSubLevels = { ...prevSubLevels };
  
  // Обновляем узел во всех уровнях где он может находиться
  Object.keys(updatedSubLevels).forEach(levelKey => {
    if (updatedSubLevels[levelKey]?.nodes) {
      updatedSubLevels[levelKey] = {
        ...updatedSubLevels[levelKey],
        nodes: updatedSubLevels[levelKey].nodes.map(node => 
          node.id === nodeId 
            ? { ...node, data: nodeData }
            : node
        )
      };
    }
  });
  
  return updatedSubLevels;
});
```

!> Обновление происходит во всех уровнях, что может повлиять на производительность при большом количестве уровней

## Использование

Хук используется в основном компоненте App.js:
```javascript
const { handleSaveNode } = useNodeSave();
```

Функция передается в компонент редактора:
```jsx
<NodeEditor
  onSave={handleSaveNode}
  // ... другие props
/>
```

## Интеграция с другими хуками

### useNodeEditor
Используется для основной логики сохранения узлов:
```javascript
const { saveNode } = useNodeEditor();
```

### updateNodeInList
Используется для обновления узлов в списке:
```javascript
import { updateNodeInList } from '../../../components/editor/system';
```

## Принципы работы

1. **Централизация** - вся логика сохранения узлов в одном месте
2. **Синхронизация** - изменения распространяются на все уровни навигации
3. **Интеграция** - использует существующие хуки для основной логики
4. **Оптимизация** - использование useCallback для предотвращения лишних созданий функций

## Особенности реализации

!> Жестко закодированная логика обновления узлов во всех уровнях может быть неэффективной при большом количестве уровней
!> Отсутствует обработка ошибок при обновлении уровней
!> Использование `node.id === nodeId` для поиска узлов может быть неэффективным при большом количестве узлов