# modules/storage/nodeRepository.js

## Описание

Репозиторий узлов данных Electron приложения Likbez. Отвечает за сохранение, загрузку и управление узлами данных и их структурой в файловой системе.

## Основные функции

### constructor(storage, serializer)

Инициализирует репозиторий узлов:

- storage: сервис хранения данных
- serializer: сериализатор узлов данных

### saveRootLevel(dataRoot, subLevels)

Сохраняет корневой уровень данных:

- Сохраняет связи корневого уровня в connections.json
- Сохраняет узлы корневого уровня
- Очищает удаленные узлы

### saveNode(parentDir, node, subLevels, depth)

Сохраняет узел данных:

- Создает или переименовывает папку узла
- Сохраняет содержимое узла через сериализатор или в node.json
- Сохраняет связи узла в connections.json
- Рекурсивно сохраняет дочерние узлы
- Удаляет неиспользуемые директории next_level

### cleanupDeletedNodes(parentDir, currentNodes)

Очищает удаленные узлы:

- Сканирует директорию на наличие папок узлов
- Сравнивает с текущими узлами
- Удаляет папки несуществующих узлов

### removeDirectory(dirPath)

Удаляет директорию рекурсивно:

- Использует storage.rm с параметрами recursive и force
- Игнорирует ошибки

### loadRootLevel(dataRoot, subLevels)

Загружает корневой уровень данных:

- Загружает связи корневого уровня из connections.json
- Загружает узлы корневого уровня
- Сохраняет данные в subLevels

### loadNodesFromDirectory(parentDir, subLevels, depth)

Загружает узлы из директории:

- Сканирует директорию на наличие папок узлов
- Загружает содержимое узлов
- Рекурсивно загружает дочерние узлы
- Сохраняет связи дочерних узлов

### findNodeFolder(parentDir, nodeId)

Находит папку узла по его ID:

- Сканирует директорию на наличие папок узлов
- Ищет папку с соответствующим ID в имени
- Возвращает путь к папке или null

### loadNodeContent(nodeDir)

Загружает содержимое узла:

- Делегирует вызов сериализатору

## Структура хранения

### Корневой уровень
- dataRoot/connections.json - связи корневого уровня
- dataRoot/{node_folder}/ - папки узлов корневого уровня

### Узлы данных
- {node_folder}/node.json - данные узла (если нет содержимого)
- {node_folder}/connections.json - связи узла
- {node_folder}/next_level/ - директория дочерних узлов
- {node_folder}/next_level/connections.json - связи дочерних узлов

## Импорты

- path: модуль для работы с путями файловой системы
- FileUtils из ../utils: утилиты для работы с файлами